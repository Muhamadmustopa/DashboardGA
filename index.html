<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard GA ‚Äî MAP</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ========= THEME VARIABLES ========= */
    :root{
      --bg: #0f172a;
      --panel: #0b1220;
      --muted: #94a3b8;
      --card-border: rgba(255,255,255,0.06);
      --accent: #10b981;
      --danger: #ef4444;
      --table-border: rgba(255,255,255,0.06);
      --text: #e6eef8;
    }
    html.light {
      --bg: #f8fafc;
      --panel: #ffffff;
      --muted: #475569;
      --card-border: rgba(15,23,42,0.06);
      --accent: #059669;
      --danger: #dc2626;
      --table-border: rgba(15,23,42,0.08);
      --text: #0b1220;
    }

    /* ========= BASE ========= */
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background:var(--bg); color:var(--text); }
    a { color:inherit; text-decoration:none; }
    .container{ max-width:1100px; margin:14px auto; padding:12px; }

    .card{ background:var(--panel); border-radius:12px; border:1px solid var(--card-border); padding:12px; margin-bottom:12px; }
    .muted{ color:var(--muted); font-size:13px; }

    h1{ margin:0; font-size:20px; font-weight:700; }

    /* ========= LOGIN SCREEN ========= */
    #loginScreen{ display:flex; align-items:center; justify-content:center; height:100vh; padding:20px; background:var(--bg); color:var(--text); }
    .login-box{ width:100%; max-width:420px; border-radius:12px; padding:22px; background:var(--panel); border:1px solid var(--card-border); text-align:center; }
    .logo{ width:96px; height:96px; margin:0 auto 14px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid var(--card-border); }
    .logo img{ width:72px; height:72px; object-fit:contain; }
    .login-title{ font-size:18px; font-weight:700; margin-bottom:6px; }
    .login-desc{ color:var(--muted); margin-bottom:14px; }

    .role-btn{ display:block; width:100%; padding:12px; border-radius:10px; border:1px solid var(--card-border); background:transparent; color:var(--text); font-weight:700; margin-bottom:8px; cursor:pointer; }
    .role-btn.admin{ background:linear-gradient(90deg,var(--accent), #00c38a); color:white; border:none; }
    .role-footer{ margin-top:10px; color:var(--muted); font-size:13px; }

    /* ========= HEADER & TOOLBAR ========= */
    .header-card{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .btn{ background:transparent; border:1px solid var(--card-border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn.primary{ background:linear-gradient(90deg,var(--accent), #00c38a); color:white; border:none; }
    .btn.small{ padding:6px 8px; font-size:12px; border-radius:8px; }

    /* theme switch */
    .theme-switch{ display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .switch{ width:52px; height:28px; border-radius:999px; background:#cbd5e1; position:relative; }
    .switch::before{ content:"üåû"; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#fff; display:grid; place-items:center; transition:all .22s; font-size:14px; }
    html.light .switch{ background:#f1f5f9; }
    .switch[data-on="1"]{ background:#334155; }
    .switch[data-on="1"]::before{ transform:translateX(24px); content:"üåô"; }

    /* ========= FILTERS ========= */
    .filters{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
    label.small{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select,input{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--card-border); background:transparent; color:var(--text); font-size:13px; }

    /* ========= KPI ========= */
    .kpi-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-top:8px; }
    .kpi{ padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .kpi .title{ font-size:12px; color:var(--muted); text-transform:uppercase; }
    .kpi .value{ font-size:20px; font-weight:700; margin-top:6px; }
    .progress-bar{ height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; margin-top:8px; }
    .progress-bar > i{ display:block; height:100%; background:linear-gradient(90deg,var(--accent), #00c38a); }

    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; }
    .chip.good{ color:#10b981; background: rgba(16,185,129,0.08); }
    .chip.warn{ color:#f59e0b; background: rgba(251,191,36,0.08); }
    .chip.bad{ color:#ef4444; background: rgba(239,68,68,0.08); }

    /* ========= CHARTS & TABLES ========= */
    .charts{ display:grid; grid-template-columns: 1fr 320px; gap:12px; }
    .h-300{ height:300px; }

    .tables{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; margin-top:12px; }
    .table-container{ max-height:300px; overflow:auto; border-radius:10px; border:1px solid var(--table-border); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    table{ width:100%; border-collapse:collapse; min-width:700px; }
    th, td{ padding:10px 12px; text-align:left; font-size:13px; border-bottom:1px solid rgba(255,255,255,0.03); }
    th{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:0.6px; }
    td .status{ padding:6px 8px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; }
    .status.done{ color:#10b981; background: rgba(16,185,129,0.08); }
    .status.process{ color:#f59e0b; background: rgba(251,191,36,0.08); }
    .status.pending{ color:#ef4444; background: rgba(239,68,68,0.08); }
    .action-btn{ margin-left:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--card-border); background:transparent; cursor:pointer; font-size:13px; color:var(--text); }

    /* card-list for mobile */
    .card-list{ display:none; }
    .card-item{ border-radius:10px; border:1px solid var(--card-border); padding:10px; margin-bottom:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .card-item .meta{ display:flex; justify-content:space-between; gap:8px; font-size:13px; color:var(--muted); }
    .card-item .title{ font-weight:700; margin:6px 0; }

    /* footer */
    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:12px; }

    /* responsive */
    @media (max-width:1000px){
      .filters{ grid-template-columns: repeat(2,1fr); }
      .kpi-grid{ grid-template-columns: repeat(2,1fr); }
      .charts{ grid-template-columns: 1fr; }
      .tables{ grid-template-columns: 1fr; }
    }
    @media (max-width:640px){
      table{ display:none; } /* hide tables on mobile */
      .card-list{ display:block; } /* show card lists */
      .kpi-grid{ grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" style="display:none;">
    <div class="login-box">
      <div class="logo">
        <!-- Placeholder logo: replace src with actual logo if available -->
        <img src="map-log.png" alt="logo">
      </div>
      <div class="login-title">Dashboard General Affair ‚Äî MAP</div>
      <div class="login-desc muted">Pilih role</div>

      <button id="btnLoginAdmin" class="role-btn admin"></button>
      <button id="btnLoginViewer" class="role-btn"> Viewer</button>

      <div class="role-footer">Copyright ¬© 2025 ‚Äî Mitra Asa Pratama</div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="app" class="container" style="display:none;">
    <!-- Header -->
    <div class="card header-card" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <h1>Dashboard General Affair ‚Äî MAP</h1>
        <div class="muted">Perawatan AC ‚Ä¢ Perawatan Kendaraan ‚Ä¢ Perawatan Elektronik ‚Ä¢ Kebersihan Area</div>
      </div>

      <div style="display:flex; align-items:center; gap:8px;">
        <div class="toolbar">
          <button id="btnCreate" class="btn primary admin-only">‚ûï Tambah Data</button>
          <div class="theme-switch" title="Ganti tema">
            <div id="themeSwitch" class="switch" data-on="1"></div>
          </div>
          <button id="btnExportCSV" class="btn">‚¨áÔ∏è Export CSV</button>
          <button id="btnEditData" class="btn">üìù </button>
          <button id="btnLogout" class="btn">‚á¶ Logout</button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card">
      <div class="filters">
        <div>
          <label class="small">Kategori</label>
          <select id="filterCategory"><option value="ALL">Semua</option></select>
        </div>
        <div>
          <label class="small">Bulan</label>
          <select id="filterMonth"></select>
        </div>
        <div>
          <label class="small">Tahun</label>
          <select id="filterYear"></select>
        </div>
        <div>
          <label class="small">Lokasi</label>
          <select id="filterLocation"><option value="ALL">Semua Lokasi</option></select>
        </div>

        <div style="grid-column: span 4; display:flex; gap:8px; margin-top:8px; align-items:center;">
          <div style="display:flex; gap:8px;">
            <label class="small">Status</label>
            <select id="filterStatus">
              <option value="ALL">Semua Status</option>
              <option value="Selesai">Selesai</option>
              <option value="Proses">Proses</option>
              <option value="Belum">Belum</option>
            </select>
          </div>
          <div style="flex:1"></div>
          <button id="btnReset" class="btn small">Reset Filter</button>
          <div class="muted" style="align-self:center;">Role: <strong id="roleLabel"></strong></div>
        </div>
      </div>
    </div>

    <!-- KPI -->
    <div id="kpiCards" class="kpi-grid"></div>

    <!-- Charts -->
    <div class="charts">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Progress per Kategori</strong><div class="muted">Selesai vs Belum</div></div>
          <div class="muted">Bar</div>
        </div>
        <div class="h-300"><canvas id="barChart" style="width:100%; height:100%;"></canvas></div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Proporsi Pekerjaan</strong><div class="muted">Jumlah per kategori</div></div>
          <div class="muted">Pie</div>
        </div>
        <div style="display:flex; align-items:center; justify-content:center;" class="h-300"><canvas id="pieChart" style="max-width:240px; max-height:240px;"></canvas></div>
      </div>
    </div>

    <!-- Ring -->
    <div class="card" style="margin-top:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div><strong>Progress Ring ‚Äî Penyelesaian Total</strong><div class="muted">Persentase selesai</div></div>
        <div class="muted">Doughnut</div>
      </div>
      <div style="display:flex; align-items:center; justify-content:center;" class="h-300">
        <canvas id="ringChart" style="max-width:260px; max-height:260px;"></canvas>
      </div>
    </div>

    <!-- Tables / Card-lists -->
    <div class="tables">
      <!-- AC -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Perawatan AC</strong><div class="muted">Detail</div></div>
          <div class="muted">Tabel</div>
        </div>
        <div class="table-container"><table id="table-ac"></table></div>
        <div id="list-ac" class="card-list" style="margin-top:8px;"></div>
      </div>

      <!-- Kendaraan -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Perawatan Kendaraan</strong><div class="muted">Detail</div></div>
          <div class="muted">Tabel</div>
        </div>
        <div class="table-container"><table id="table-kendaraan"></table></div>
        <div id="list-kendaraan" class="card-list" style="margin-top:8px;"></div>
      </div>

      <!-- Elektronik -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Perawatan Elektronik</strong><div class="muted">Detail</div></div>
          <div class="muted">Tabel</div>
        </div>
        <div class="table-container"><table id="table-elektronik"></table></div>
        <div id="list-elektronik" class="card-list" style="margin-top:8px;"></div>
      </div>

      <!-- Kebersihan -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div><strong>Kebersihan Area</strong><div class="muted">Detail</div></div>
          <div class="muted">Tabel</div>
        </div>
        <div class="table-container"><table id="table-kebersihan"></table></div>
        <div id="list-kebersihan" class="card-list" style="margin-top:8px;"></div>
      </div>
    </div>

    <footer>Copyright ¬© 2025 ‚Äî GA -Mitra Asa Pratama</footer>
  </div>

  <!-- JSON Editor Modal -->
  <dialog id="editorModal">
    <div style="padding:12px; min-width:320px;" class="modal-inner card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong> (records)</strong>
        <div>
          <button id="closeEditor" class="btn">Tutup</button>
        </div>
      </div>
      <textarea id="editorTextarea" style="width:100%; height:320px; border-radius:8px; padding:8px; background:transparent; border:1px solid var(--card-border); color:inherit; font-family:monospace;"></textarea>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
        <button id="editorCancel" class="btn">Batal</button>
        <button id="editorSave" class="btn primary">Simpan</button>
      </div>
    </div>
  </dialog>

  <!-- CRUD Modal -->
  <dialog id="crudModal">
    <div style="padding:12px; min-width:320px;" class="modal-inner card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong id="crudTitle">Tambah Data</strong>
        <div>
          <button id="crudClose" class="btn">Tutup</button>
        </div>
      </div>

      <form id="crudForm" onsubmit="return false;">
        <input type="hidden" id="crudId">
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:8px;">
          <div>
            <label class="small">Kategori</label>
            <select id="crudKategori"><option>AC</option><option>Kendaraan</option><option>Elektronik</option><option>Kebersihan</option></select>
          </div>
          <div>
            <label class="small">Tanggal</label>
            <input type="date" id="crudTanggal">
          </div>
          <div style="grid-column:span 2;">
            <label class="small">Judul / Deskripsi</label>
            <input type="text" id="crudJudul" placeholder="Deskripsi pekerjaan">
          </div>
          <div>
            <label class="small">Lokasi</label>
            <input type="text" id="crudLokasi">
          </div>
          <div>
            <label class="small">Status</label>
            <select id="crudStatus"><option>Selesai</option><option>Proses</option><option>Belum</option></select>
          </div>
          <div>
            <label class="small">PIC</label>
            <input type="text" id="crudPIC">
          </div>
          <div>
            <label class="small">Biaya (IDR)</label>
            <input type="number" id="crudBiaya" min="0" step="1" value="0">
          </div>
          <div style="grid-column:span 2;">
            <label class="small">Catatan</label>
            <textarea id="crudCatatan" rows="3"></textarea>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button id="crudCancel" class="btn">Batal</button>
          <button id="btnCrudSave" class="btn primary">Simpan</button>
        </div>
      </form>
    </div>
  </dialog>

<script>
/* ============================
   Dashboard Final with Login
   ============================ */

const LS_KEY = 'dashboard-ga-records-v1';
const LS_THEME = 'dashboard-ga-theme-v1';
const ROLE_KEY = 'dashboard-ga-role-v1';

/* ---------- Sample data (default) ---------- */
let records = [
  { id:1, kategori:'AC', judul:'Cuci AC Split Ruang HR', lokasi:'Lantai 2 - HR', tanggal:'2025-08-05', status:'Selesai', penanggungJawab:'Adi', biaya:250000, catatan:'Freon normal' },
  { id:2, kategori:'AC', judul:'Periksa kebocoran AC Server', lokasi:'Ruang Server', tanggal:'2025-08-10', status:'Proses', penanggungJawAb:'Budi', penanggungJawab:'Budi', biaya:0, catatan:'Cek pipa drain' },
  { id:3, kategori:'AC', judul:'Ganti filter AC Lobby', lokasi:'Lobby', tanggal:'2025-08-14', status:'Belum', penanggungJawAb:'Dedi', penanggungJawab:'Dedi', biaya:100000, catatan:'' },
  { id:11, kategori:'Kendaraan', judul:'Service Berkala Avanza', lokasi:'Bengkel Resmi', tanggal:'2025-08-03', status:'Selesai', penanggungJawAb:'Rina', penanggungJawab:'Rina', biaya:950000, catatan:'Ganti oli' },
  { id:12, kategori:'Kendaraan', judul:'Perpanjang STNK Motor', lokasi:'Samsat', tanggal:'2025-08-12', status:'Selesai', penanggungJawAb:'Joko', penanggungJawab:'Joko', biaya:450000, catatan:'' },
  { id:13, kategori:'Kendaraan', judul:'Tambal Ban Motor', lokasi:'Parkir Basement', tanggal:'2025-08-15', status:'Proses', penanggungJawAb:'Rina', penanggungJawab:'Rina', biaya:15000, catatan:'' },
  { id:21, kategori:'Elektronik', judul:'Periksa Printer Keuangan', lokasi:'Keuangan', tanggal:'2025-08-02', status:'Selesai', penanggungJawAb:'Andi', penanggungJawab:'Andi', biaya:0, catatan:'Cleaning head' },
  { id:22, kategori:'Elektronik', judul:'Ganti Mouse Procurement', lokasi:'Procurement', tanggal:'2025-08-08', status:'Selesai', penanggungJawAb:'Sari', penanggungJawab:'Sari', biaya:75000, catatan:'' },
  { id:23, kategori:'Elektronik', judul:'Instal Ulang OS Div. R&D', lokasi:'R&D', tanggal:'2025-08-13', status:'Belum', penanggungJawAb:'Fajar', penanggungJawab:'Fajar', biaya:0, catatan:'Backup dulu' },
  { id:31, kategori:'Kebersihan', judul:'Deep Cleaning Pantry', lokasi:'Pantry', tanggal:'2025-08-01', status:'Selesai', penanggungJawAb:'Tim OB', penanggungJawab:'Tim OB', biaya:0, catatan:'' },
  { id:32, kategori:'Kebersihan', judul:'General Cleaning Musholla', lokasi:'Musholla', tanggal:'2025-08-09', status:'Selesai', penanggungJawAb:'Tim OB', penanggungJawab:'Tim OB', biaya:0, catatan:'' },
  { id:33, kategori:'Kebersihan', judul:'Pembersihan Jamur Dinding', lokasi:'Gudang', tanggal:'2025-08-16', status:'Belum', penanggungJawAb:'Tim OB', penanggungJawab:'Tim OB', biaya:0, catatan:'Butuh cairan anti jamur' },
];

/* ---------- State ---------- */
let role = sessionStorage.getItem(ROLE_KEY) || null;

/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const months = ['01|Januari','02|Februari','03|Maret','04|April','05|Mei','06|Juni','07|Juli','08|Agustus','09|September','10|Oktober','11|November','12|Desember'];
function fmtCurrency(n){ return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n||0); }
function categoryList(){ return ['AC','Kendaraan','Elektronik','Kebersihan']; }

/* ---------- Persistence ---------- */
function loadFromStorage(){
  try {
    const s = localStorage.getItem(LS_KEY);
    if(s){
      const parsed = JSON.parse(s);
      if(Array.isArray(parsed) && parsed.length>0) records = parsed;
    } else {
      localStorage.setItem(LS_KEY, JSON.stringify(records));
    }
  } catch(e){ console.warn(e); }
}
function saveToStorage(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(records)); }catch(e){console.warn(e);} }

/* ---------- Theme ---------- */
function applyTheme(theme){
  if(theme === 'light'){ document.documentElement.classList.add('light'); $('#themeSwitch').setAttribute('data-on','0'); }
  else { document.documentElement.classList.remove('light'); $('#themeSwitch').setAttribute('data-on','1'); }
  localStorage.setItem(LS_THEME, theme);
}
function initTheme(){
  let t = localStorage.getItem(LS_THEME);
  if(!t) t = 'dark';
  applyTheme(t);
}

/* ---------- Login flow (simple) ---------- */
function showLogin(){
  $('#loginScreen').style.display = 'flex';
  $('#app').style.display = 'none';
}
function showApp(){
  $('#loginScreen').style.display = 'none';
  $('#app').style.display = 'block';
}
function doLogin(asRole){
  role = asRole === 'admin' ? 'admin' : 'viewer';
  sessionStorage.setItem(ROLE_KEY, role);
  $('#roleLabel').textContent = role;
  if(role !== 'admin') $$('.admin-only').forEach(el => el.style.display = 'none');
  else $$('.admin-only').forEach(el => el.style.display = '');
  showApp();
  // boot UI
  loadFromStorage();
  initTheme();
  initFilters();
  bindEvents(); // binds some events (idempotent)
  renderAll();
}
function doLogout(){
  sessionStorage.removeItem(ROLE_KEY);
  role = null;
  // optionally keep theme in localStorage
  showLogin();
}

/* ---------- Filters & rebuild location (dynamic by category) ---------- */
function initFilters(){
  $('#filterCategory').innerHTML = `<option value="ALL">Semua</option>` + categoryList().map(c=>`<option value="${c}">${c}</option>`).join('');
  $('#filterMonth').innerHTML = months.map(s=>{ const [v,t] = s.split('|'); return `<option value="${v}">${t}</option>`; }).join('');
  const yNow = new Date().getFullYear(); let ys=[]; for(let y=yNow-2;y<=yNow+1;y++) ys.push(`<option value="${y}">${y}</option>`);
  $('#filterYear').innerHTML = ys.join('');
  const now = new Date();
  $('#filterMonth').value = String(now.getMonth()+1).padStart(2,'0');
  $('#filterYear').value = String(now.getFullYear());
  rebuildLocationFilter();
}
function rebuildLocationFilter(){
  const cat = $('#filterCategory').value || 'ALL';
  const locs = Array.from(new Set(records.filter(r => (cat==='ALL' ? true : r.kategori===cat) ).map(r=>r.lokasi||'').filter(Boolean))).sort();
  const sel = $('#filterLocation');
  sel.innerHTML = '<option value="ALL">Semua Lokasi</option>' + locs.map(l=>`<option value="${l}">${l}</option>`).join('');
}

/* ---------- Filtering logic ---------- */
function getPeriod(){ return { m: $('#filterMonth').value, y: $('#filterYear').value }; }
function byPeriod(rec,m,y){ if(!rec||!rec.tanggal) return false; const d = new Date(rec.tanggal); if(isNaN(d)) return false; return String(d.getMonth()+1).padStart(2,'0')===m && String(d.getFullYear())===String(y); }
function byFilters(rec){
  const {m,y} = getPeriod();
  const cat = $('#filterCategory').value || 'ALL';
  const loc = $('#filterLocation').value || 'ALL';
  const st = $('#filterStatus').value || 'ALL';
  const okPeriod = byPeriod(rec,m,y);
  const okCat = cat === 'ALL' || rec.kategori === cat;
  const okLoc = loc === 'ALL' || rec.lokasi === loc;
  const okSt = st === 'ALL' || rec.status === st;
  return okPeriod && okCat && okLoc && okSt;
}

/* ---------- KPI ---------- */
function kpiFor(cat, items){
  const total = items.length;
  const selesai = items.filter(i => i.status === 'Selesai').length;
  const belum = items.filter(i => i.status !== 'Selesai').length;
  const biaya = items.reduce((a,b)=>a+(Number(b.biaya)||0),0);
  const pct = total ? Math.round((selesai/total)*100) : 0;
  return {cat,total,selesai,belum,biaya,pct};
}
function badgeHtml(pct){
  if(pct>=90) return `<span class="chip good">Baik</span>`;
  if(pct>=70) return `<span class="chip warn">Perlu perhatian</span>`;
  return `<span class="chip bad">Butuh tindakan</span>`;
}
function renderKPIs(){
  const data = categoryList().map(cat => {
    const items = records.filter(r=>r.kategori===cat && byFilters(r));
    return kpiFor(cat, items);
  });
  const html = data.map(d=>`
    <div class="kpi card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="title">${d.cat}</div>
        ${badgeHtml(d.pct)}
      </div>
      <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:8px;">
        <div>
          <div class="value">${d.pct}%</div>
          <div class="muted" style="font-size:12px;">${d.selesai}/${d.total} selesai</div>
        </div>
        <div style="text-align:right; font-size:12px; color:var(--muted);">
          <div>Belum: <b>${d.belum}</b></div>
          <div style="margin-top:6px">Biaya: <b>${fmtCurrency(d.biaya)}</b></div>
        </div>
      </div>
      <div class="progress-bar"><i style="width:${d.pct}%"></i></div>
    </div>
  `).join('');
  $('#kpiCards').innerHTML = html;
}

/* ---------- Tables & mobile card lists ---------- */
function tableTemplate(items){
  if(!items || items.length===0) return `<div style="padding:12px;" class="muted">Tidak ada data untuk filter ini.</div>`;
  const head = `<thead><tr><th>Tanggal</th><th>Judul</th><th>Lokasi</th><th>PIC</th><th>Status</th><th style="text-align:right">Biaya</th><th>Aksi</th></tr></thead>`;
  const body = items.map(r=>{
    const statClass = r.status==='Selesai' ? 'status done' : (r.status==='Proses' ? 'status process' : 'status pending');
    return `<tr>
      <td style="white-space:nowrap">${r.tanggal||''}</td>
      <td>${r.judul||''}</td>
      <td>${r.lokasi||''}</td>
      <td style="white-space:nowrap">${r.penanggungJawab||'-'}</td>
      <td><span class="${statClass}">${r.status||''}</span></td>
      <td style="text-align:right">${fmtCurrency(r.biaya)}</td>
      <td style="white-space:nowrap">
        <button class="action-btn" data-action="edit" data-id="${r.id}">‚úèÔ∏è</button>
        <button class="action-btn" data-action="delete" data-id="${r.id}">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
  return head + `<tbody>${body}</tbody>`;
}
function renderCardList(items, containerId){
  const container = document.getElementById(containerId);
  if(!container) return;
  if(!items || items.length===0){ container.innerHTML = ''; return; }
  container.innerHTML = items.map(r=>{
    return `<div class="card-item">
      <div class="meta"><div>${r.tanggal||''}</div><div>${fmtCurrency(r.biaya)}</div></div>
      <div class="title">${r.judul || ''}</div>
      <div class="muted">${r.lokasi || ''} ‚Ä¢ ${r.penanggungJawab || '-'}</div>
      <div style="display:flex; justify-content:space-between; margin-top:8px; align-items:center;">
        <div><span class="${r.status==='Selesai'?'status done':(r.status==='Proses'?'status process':'status pending')}">${r.status}</span></div>
        <div>
          <button class="action-btn" data-action="edit" data-id="${r.id}">‚úèÔ∏è</button>
          <button class="action-btn" data-action="delete" data-id="${r.id}">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}
function renderTables(){
  const ac = records.filter(r=>r.kategori==='AC' && byFilters(r)).sort((a,b)=>String(a.tanggal||'').localeCompare(String(b.tanggal||'')));
  const kn = records.filter(r=>r.kategori==='Kendaraan' && byFilters(r)).sort((a,b)=>String(a.tanggal||'').localeCompare(String(b.tanggal||'')));
  const el = records.filter(r=>r.kategori==='Elektronik' && byFilters(r)).sort((a,b)=>String(a.tanggal||'').localeCompare(String(b.tanggal||'')));
  const kb = records.filter(r=>r.kategori==='Kebersihan' && byFilters(r)).sort((a,b)=>String(a.tanggal||'').localeCompare(String(b.tanggal||'')));

  $('#table-ac').innerHTML = tableTemplate(ac);
  $('#table-kendaraan').innerHTML = tableTemplate(kn);
  $('#table-elektronik').innerHTML = tableTemplate(el);
  $('#table-kebersihan').innerHTML = tableTemplate(kb);

  renderCardList(ac, 'list-ac');
  renderCardList(kn, 'list-kendaraan');
  renderCardList(el, 'list-elektronik');
  renderCardList(kb, 'list-kebersihan');
}

/* ---------- Charts (Chart.js) ---------- */
let barChart=null, pieChart=null, ringChart=null;
function destroyCharts(){ if(barChart){barChart.destroy(); barChart=null;} if(pieChart){pieChart.destroy(); pieChart=null;} if(ringChart){ringChart.destroy(); ringChart=null;} }
function renderCharts(){
  destroyCharts();
  const cats = categoryList();
  const selesai=[], belum=[], totals=[];
  let totalDone=0, totalAll=0;
  cats.forEach(cat=>{
    const items = records.filter(r=>r.kategori===cat && byFilters(r));
    const total = items.length;
    const done = items.filter(i=>i.status==='Selesai').length;
    selesai.push(done); belum.push(total - done); totals.push(total);
    totalDone += done; totalAll += total;
  });

  // Bar
  const barCtx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(barCtx, {
    type:'bar',
    data:{ labels:cats, datasets:[
      { label:'Selesai', data:selesai, backgroundColor:'rgba(16,185,129,0.95)' },
      { label:'Belum', data:belum, backgroundColor:'rgba(239,68,68,0.95)' }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'top'} }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });

  // Pie
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  pieChart = new Chart(pieCtx, {
    type:'pie',
    data:{ labels:cats, datasets:[{ data:totals, backgroundColor:['#06b6d4','#f97316','#6366f1','#10b981'] }] },
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // Doughnut ring
  const pct = totalAll ? Math.round((totalDone/totalAll)*100) : 0;
  const ringCtx = document.getElementById('ringChart').getContext('2d');
  ringChart = new Chart(ringCtx, {
    type:'doughnut',
    data:{ labels:['Selesai','Sisa'], datasets:[{ data:[totalDone, Math.max(totalAll-totalDone,0)], backgroundColor:['#10b981','#6b7280'] }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'72%', plugins:{ legend:{display:false} } },
    plugins:[{
      id:'centerText',
      afterDraw(chart){ const {ctx, chartArea} = chart; const x=(chartArea.left+chartArea.right)/2; const y=(chartArea.top+chartArea.bottom)/2+6; ctx.save(); ctx.fillStyle=getComputedStyle(document.documentElement).color; ctx.font='700 20px Inter, system-ui, sans-serif'; ctx.textAlign='center'; ctx.fillText(pct + '%', x, y); ctx.restore(); }
    }]
  });
}

/* ---------- Export CSV ---------- */
function exportCSV(){
  const header = ['id','kategori','judul','lokasi','tanggal','status','penanggungJawab','biaya','catatan'];
  const rows = records.filter(byFilters).map(r => header.map(h => (r[h]??'').toString().replaceAll('"','""')));
  const csv = [header.join(','), ...rows.map(r=>r.map(c=>`"${c}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `dashboard-ga_${$('#filterYear').value}-${$('#filterMonth').value}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- JSON Editor ---------- */
function openEditor(){ $('#editorTextarea').value = JSON.stringify(records,null,2); document.getElementById('editorModal').showModal(); }
function closeEditor(){ document.getElementById('editorModal').close(); }
function saveEditor(){ try{ const parsed = JSON.parse($('#editorTextarea').value); if(!Array.isArray(parsed)) throw new Error('Format harus array []'); records = parsed; saveToStorage(); rebuildLocationFilter(); renderAll(); closeEditor(); } catch(e){ alert('Gagal simpan: '+ e.message); } }

/* ---------- CRUD helpers ---------- */
function newId(){ return (records.reduce((m,r)=>Math.max(m, Number(r.id)||0), 0) + 1); }
function getById(id){ return records.find(r=>Number(r.id)===Number(id)); }
function upsertRecord(payload){ const idx = records.findIndex(r=>Number(r.id)===Number(payload.id)); if(idx>=0) records[idx] = payload; else records.push(payload); saveToStorage(); }
function deleteRecord(id){ if(!confirm('Hapus data ini?')) return; const idx = records.findIndex(r=>Number(r.id)===Number(id)); if(idx>=0){ records.splice(idx,1); saveToStorage(); renderAll(); rebuildLocationFilter(); } }

/* ---------- CRUD modal UI ---------- */
function openCreateModal(){ $('#crudTitle').textContent='Tambah Data'; $('#crudId').value=''; $('#crudKategori').value='AC'; $('#crudTanggal').value = new Date().toISOString().slice(0,10); $('#crudJudul').value=''; $('#crudLokasi').value=''; $('#crudStatus').value='Proses'; $('#crudPIC').value=''; $('#crudBiaya').value=0; $('#crudCatatan').value=''; document.getElementById('crudModal').showModal(); }
function openEditModal(id){ const r = getById(id); if(!r) return; $('#crudTitle').textContent='Edit Data'; $('#crudId').value=r.id; $('#crudKategori').value=r.kategori; $('#crudTanggal').value=r.tanggal||new Date().toISOString().slice(0,10); $('#crudJudul').value=r.judul||''; $('#crudLokasi').value=r.lokasi||''; $('#crudStatus').value=r.status||'Proses'; $('#crudPIC').value=r.penanggungJawab||''; $('#crudBiaya').value=r.biaya||0; $('#crudCatatan').value=r.catatan||''; document.getElementById('crudModal').showModal(); }
function closeCrudModal(){ document.getElementById('crudModal').close(); }
function saveCrud(){ if(role !== 'admin'){ alert('Hanya admin dapat menyimpan'); return; } const id = Number($('#crudId').value) || newId(); const payload = { id, kategori: $('#crudKategori').value, tanggal: $('#crudTanggal').value || new Date().toISOString().slice(0,10), judul: ($('#crudJudul').value||'').trim(), lokasi: ($('#crudLokasi').value||'').trim(), status: $('#crudStatus').value, penanggungJawab: ($('#crudPIC').value||'').trim(), biaya: Number($('#crudBiaya').value)||0, catatan: ($('#crudCatatan').value||'').trim() }; if(!payload.judul){ alert('Judul wajib diisi'); return; } upsertRecord(payload); rebuildLocationFilter(); renderAll(); closeCrudModal(); }

/* ---------- Delegated actions ---------- */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-action]');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  if(action === 'edit'){ if(role !== 'admin'){ alert('Hanya admin dapat mengedit'); return; } openEditModal(id); }
  if(action === 'delete'){ if(role !== 'admin'){ alert('Hanya admin dapat menghapus'); return; } deleteRecord(id); }
});

/* ---------- Render all ---------- */
function renderAll(){ renderKPIs(); renderCharts(); renderTables(); }

/* ---------- Bind events (idempotent safe) ---------- */
function bindEvents(){
  // login buttons
  $('#btnLoginAdmin').addEventListener('click', ()=> doLogin('admin'));
  $('#btnLoginViewer').addEventListener('click', ()=> doLogin('viewer'));
  $('#btnLogout').addEventListener('click', ()=> { doLogout(); });

  // filters
  ['filterCategory','filterMonth','filterYear','filterLocation','filterStatus'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', ()=>{
      if(id === 'filterCategory') rebuildLocationFilter();
      renderAll();
    });
  });

  $('#btnReset').addEventListener('click', ()=>{ initFilters(); renderAll(); });

  // toolbar actions
  $('#btnExportCSV').addEventListener('click', exportCSV);
  $('#btnEditData').addEventListener('click', openEditor);

  $('#closeEditor').addEventListener('click', closeEditor);
  $('#editorCancel').addEventListener('click', closeEditor);
  $('#editorSave').addEventListener('click', saveEditor);

  $('#themeSwitch').addEventListener('click', ()=>{
    const current = localStorage.getItem(LS_THEME) === 'light' ? 'light' : 'dark';
    const next = current === 'light' ? 'dark' : 'light';
    applyTheme(next);
  });

  // CRUD modal actions
  $('#btnCreate').addEventListener('click', ()=> { if(role !== 'admin'){ alert('Hanya admin dapat menambah'); return; } openCreateModal(); });
  $('#crudClose').addEventListener('click', closeCrudModal);
  $('#crudCancel').addEventListener('click', closeCrudModal);
  $('#btnCrudSave').addEventListener('click', saveCrud);

  // shortcut open editor
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); openEditor(); }});
}

/* ---------- Boot ---------- */
(function boot(){
  bindEvents();
  // check role in session
  role = sessionStorage.getItem(ROLE_KEY);
  if(!role){
    showLogin();
  } else {
    $('#roleLabel').textContent = role;
    if(role !== 'admin') $$('.admin-only').forEach(el => el.style.display = 'none');
    else $$('.admin-only').forEach(el => el.style.display = '');
    showApp();
    loadFromStorage();
    initTheme();
    initFilters();
    renderAll();
  }
})();
</script>
</body>
</html>
